(function($){$.fn.tab=function(options){var tabId='',DATA_NAME='lib-tab',config=options||{};this.each(function(){var tab=new lib.Tab(config,$(this));tabId=tab.getId();$(this).data(DATA_NAME+tabId,tab);});return $(this).data(DATA_NAME+tabId);};var lib=lib||{};lib.Tab=function(options,container){$.extend(true,this,lib.Tab.defaults,options,{'container':container});this.id=this.getId();this._init();};lib.Tab.defaults={id:'',position:{type:'absolute',top:null,left:null},width:'500px',height:'400px',items:[],moveSize:'50px',container:$(document.body),handler:$.noop};lib.Tab.AUTO_ID=100;lib.Tab.ITEM_ID=0;lib.Tab.ITEM_WIDTH='120px';lib.Tab.CLOSE={arrow:{cls:'button-arrow'}};lib.Tab.prototype={_init:function(){var self=this;var _tabHtml=[];_tabHtml.push('<div class="tab" id="'+self.id+'">');_tabHtml.push(' <div class="tab-control">');_tabHtml.push('  <div class="tab-item">');_tabHtml.push('   <ul></ul>');_tabHtml.push('  </div>');_tabHtml.push('  <div class="tab-spacer"></div>');_tabHtml.push(' </div>');_tabHtml.push(' <div class="tab-content"></div>');_tabHtml.push('</div>');var _doc=self._doc=$(_tabHtml.join(''));self._doc.appendTo(self.container);var _tab=self._tab=$('#'+self.id);self._tab_control=$('.tab-control',_doc);self._tab_item=$('.tab-item',_doc);self._tab_item_ul=$('.tab-item > ul',_doc);self._tab_spacer=$('.tab-spacer',_doc);self._tab_content=$('.tab-content',_doc);self.tabArray=[];self.tabItemIds=[];self.active=0;self._enableScroll=false;self._loadTab();},_loadTab:function(){var self=this,_totalWidth=0;self.setHeight(self.height).setWidth(self.width).setPosition(self.position);self._tab_item.css('width',(self.getWidth()*10)+'px');self.addItem(self.items);self._tab_content.height(self.getHeight()-self._tab_control.outerHeight());self.show(self.active);},addItem:function(items){var self=this,_items=items;if(_items&&$.isArray(_items)&&_items.length>0){for(var i=0,len=_items.length;i<len;i++){var item=_items[i];self.addItem(item);}}else{var _id=self._getItemId(items);if(self.tabArray[_id]){self.show(_id);}else{self._add(items,_id);}}},_add:function(item,id){var self=this,_btn=null;var _li=$('<li></li>').appendTo(self._tab_item_ul);var _div=$('<div></div>').css('position','absolute');_div.appendTo(self._tab_content).css({width:'100%',height:'100%',top:'0px',left:'0px'});switch($.type(item)){case'number':case'date':case'string':item=item+'';_btn=_li.button({text:item,title:item});break;case'object':if($.isPlainObject(item)&&!$.isEmptyObject(item)){item=item.closable?$.extend(lib.Tab.CLOSE,item):item;_btn=_li.button(item);_div.html(item.content||'');if(item.closable){_btn._btn_arrow.bind('click',function(){self.close(id);});}}break;}_div.hide();_btn.setPosition({type:'relative',top:'2px'});$("#"+_btn.getId()).unbind('click.button mousedown.button mouseup.button').bind('click.tab',function(){self.show(id);});_li.css({'width':_btn.getOuterWidth(),'height':_btn.getOuterHeight()});self.tabArray[id]={'li':_li,'div':_div};self.tabItemIds.push({'id':id});self._loadScroll('+',id);},_loadScroll:function(operate,itemId){var self=this,_tabItem=self._tab_item,_item=self.tabArray[itemId],_totalWidth=_tabItem.data('totalWidth')||0,_rightDiv=null;if(operate==='+'){_tabItem.data('totalWidth',_totalWidth+_item.li.outerWidth(true));}else if(operate==='-'){_tabItem.data('totalWidth',_totalWidth-_item.li.outerWidth(true));}_totalWidth=_tabItem.data('totalWidth');if(_totalWidth>self.getWidth()){if(!self._enableScroll){self._addScroll();_rightDiv=self._tab_control.find('.tab-scroll-right');}if(operate==='+'){_tabItem.data('maxMove',_tabItem.data('maxMove')?_tabItem.data('maxMove')+_item.li.outerWidth(true):_totalWidth-self.getWidth()+_rightDiv.outerWidth()+3);}else if(operate==='-'){_tabItem.data('maxMove',_tabItem.data('maxMove')-_item.li.outerWidth(true));}}else if(_totalWidth<=self.getWidth()){if(self._enableScroll){self._deleteScroll();}}},_addScroll:function(){var self=this;self._enableScroll=true;var _leftDiv=$('<div class="tab-scroll-left"></div>').appendTo(self._tab_control),_rightDiv=$('<div class="tab-scroll-right"></div>').appendTo(self._tab_control),_tabItem=self._tab_item,_totalWidth=_tabItem.data('totalWidth'),_time=null;_tabItem.data('miniMove',_leftDiv.outerWidth());_tabItem.css('margin-left',_leftDiv.outerWidth()+'px');_leftDiv.bind({'mousedown.tab':function(){_time=window.setInterval(function(){self._move('left');},300);$(document).bind('mouseup.tab',function(){window.setTimeout(function(){window.clearInterval(_time);},200);$(this).unbind('mouseup.tab');});}});_rightDiv.bind({'mousedown.tab':function(){_time=window.setInterval(function(){self._move('right');},300);$(document).bind('mouseup.tab',function(){window.setTimeout(function(){window.clearInterval(_time);},200);$(this).unbind('mouseup.tab');});}});},_deleteScroll:function(){var self=this;self._enableScroll=false;self._tab_control.find('.tab-scroll-left').remove();self._tab_control.find('.tab-scroll-right').remove();self._tab_item.css('margin-left','0px');},_move:function(direction){var self=this,_tabItemControl=self._tab_control,_tabItem=self._tab_item,_miniMove=_tabItem.data('miniMove'),_maxMove=_tabItem.data('maxMove'),_marginLeft=parseInt(_tabItem.css('margin-left')),_distance=0;if(direction==='left'){if(_marginLeft===_miniMove){return;}_distance=_marginLeft+parseInt(self.moveSize);if(_distance>_miniMove){_distance=_miniMove;}}else if(direction==='right'){if(Math.abs(_marginLeft)===_maxMove){return;}_distance=_marginLeft-parseInt(self.moveSize);if(Math.abs(_distance)>_maxMove){_distance=-_maxMove;}}_tabItem.animate({'margin-left':_distance+'px'},300);},_moveTo:function(itemId){var self=this,itemId=(self.tabItemIds[itemId]&&self.tabItemIds[itemId].id)||itemId;if(self._enableScroll){if(self.tabArray&&$.isArray(self.tabArray)&&self.tabArray[itemId]){var _item=self.tabArray[itemId],_li=_item.li,_div=_item.div,_tabItem=self._tab_item,_marginLeft=parseInt(_tabItem.css('margin-left')),_miniMove=_tabItem.data('miniMove'),_leftScroll=self._tab_control.find('.tab-scroll-left'),_rightScroll=self._tab_control.find('.tab-scroll-right'),_distance=0;if(_li.position().left+_li.outerWidth()>self.getWidth()-_leftScroll.outerWidth()){_distance=-(_li.position().left+_li.outerWidth(true)+_rightScroll.outerWidth()-self.getWidth()+3);}else{_distance=_miniMove;}_tabItem.animate({'margin-left':_distance+'px'},300);}}},show:function(itemId){var self=this,itemId=(self.tabItemIds[itemId]&&self.tabItemIds[itemId].id)||itemId;if(self.tabArray&&$.isArray(self.tabArray)&&self.tabArray[itemId]){var _item=self.tabArray[itemId],_li=_item.li,_div=_item.div;if(_div.is(':hidden')){if(self.tabItemIds[self.active]&&self.tabArray[self.tabItemIds[self.active].id]){var oldItem=self.tabArray[self.tabItemIds[self.active].id];oldItem.li.find('.button').removeClass('button-click');oldItem.div.hide();}self.active=self.getItemIndex(itemId);_li.find('.button').addClass('button-click');_div.show();self._moveTo(itemId);}}},close:function(itemId){var self=this,itemId=(self.tabItemIds[itemId]&&self.tabItemIds[itemId].id)||itemId;if(self.tabArray&&$.isArray(self.tabArray)&&self.tabArray[itemId]){var _item=self.tabArray[itemId],_li=_item.li,_div=_item.div,_index=self.getItemIndex(itemId),_active=self.active>_index?--self.active:self.active,_length=self.tabItemIds.length;if(_length===1){if(confirm('是否关闭整个标签页？')){self.destroy();}return;}self._loadScroll('-',itemId);_li.remove();_div.remove();delete self.tabArray[itemId];for(var i=0;i<_length;i++){if(self.tabItemIds[i].id===itemId){self.tabItemIds.splice(i,1);break;}}if(_active===_index){if(_active===_length-1){self.show(self.tabItemIds.length-1);}else{self.show(self.active);}}}},destroy:function(){this._tab.remove();},getItemIndex:function(itemId){var self=this;if(self.tabArray[itemId]){for(var i=0,len=self.tabItemIds.length;i<len;i++){if(self.tabItemIds[i].id===itemId){return i;}}}},getItem:function(itemId){var self=this,itemId=(self.tabItemIds[itemId]&&self.tabItemIds[itemId].id)||itemId;if(self.tabArray&&$.isArray(self.tabArray)&&self.tabArray[itemId])return self.tabArray[itemId];},getOuterHeight:function(){return this._tab.outerHeight();},getOuterWidth:function(){return this._tab.outerWidth();},getHeight:function(){return this._tab.height();},getWidth:function(){return this._tab.width();},setHeight:function(height){this._tab.css('height',typeof height==='number'?height+'px':height);return this;},setWidth:function(width){this._tab.css('width',typeof width==='number'?width+'px':width);return this;},setPosition:function(position){this._tab.css({'position':position.type?position.type:'absolute','top':typeof position.top==='number'?position.top+'px':position.top,'left':typeof position.left==='number'?position.left+'px':position.left});return this;},_getItemId:function(item){return item&&item.id||'autoId-tabItem-'+(lib.Tab.ITEM_ID++);},getId:function(){return this.id||(this.id='autoId-tab-'+(++lib.Tab.AUTO_ID));}};})(jQuery);